!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e["checkers-logic"]={})}(this,function(e){"use strict";var s=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},t=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},u=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},h=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var i=[],o=!0,n=!1,r=void 0;try{for(var s,a=e[Symbol.iterator]();!(o=(s=a.next()).done)&&(i.push(s.value),!t||i.length!==t);o=!0);}catch(e){n=!0,r=e}finally{try{!o&&a.return&&a.return()}finally{if(n)throw r}}return i}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")},l=function(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)},p=function t(e,i){var o=this;s(this,t),this.add=function(e){return new t(o.x+e.x,o.y+e.y)},this.mul=function(e){return new t(e*o.x,e*o.y)},this.toString=function(){return"("+o.x+", "+o.y+")"},this.equals=function(e){return o.x===e.x&&o.y===e.y},this.x=e,this.y=i},v=0,c=1,g=function e(t,i){var o=this,n=2<arguments.length&&void 0!==arguments[2]&&arguments[2];s(this,e),this.toString=function(){return o.startPosition.toString()+" -> "+o.endPosition.toString()},this.toJSON=function(){return{start:{x:o.startPosition.x,y:o.startPosition.y},end:{x:o.endPosition.x,y:o.endPosition.y},piece:!!o.takenPiece&&o.takenPiece.toJSON(),pieceBeforePromotion:!!o.pieceBeforePromotion&&o.pieceBeforePromotion.toJSON()}},this.startPosition=t,this.endPosition=i,this.takenPiece=n,this.pieceBeforePromotion=!1},i=function e(t,i){var o=this;s(this,e),this.sameSide=function(e){return e.player.sameSide(o.player)},this.position=t,this.player=i,this.active=!0},f=function(e){function r(){var e,t,c;s(this,r);for(var i=arguments.length,o=Array(i),n=0;n<i;n++)o[n]=arguments[n];return(t=c=u(this,(e=r.__proto__||Object.getPrototypeOf(r)).call.apply(e,[this].concat(o)))).toString=function(){return"K"},c.getDirections=function(){return[new p(-1,1),new p(1,1),new p(-1,-1),new p(1,-1)]},c.getPromottedPiece=function(){return!1},c.getMoves=function(r){var e=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];console.log("[getMoves] For piece "+c.toString()+" on position "+c.position.toString());var t=c.getDirections(),s=[],a=[];if(t.forEach(function(e){console.log("[getMoves] Studying direction "+e.toString());var t=r.get2ClosestPiecesAlongDir(c.position,e),i=h(t,2),o=i[0],n=i[1];if(!o)return console.log("[getMoves] No piece in this direction"),void s.push.apply(s,l(r.getMovesAlongDir(c.position,e,c.position)));c.sameSide(o)?(console.log("[getMoves] Piece "+o.position.toString()+" on the same side in this direction"),s.push.apply(s,l(r.getMovesAlongDir(c.position,e,c.position,o.position)))):(console.log("[getMoves] Piece "+o.position.toString()+" on the opposite side in this direction - yummy"),a.push.apply(a,l(r.getMovesAlongDir(c.position,e,o.position,!!n&&n.position,o))))}),0===a.length)return console.log("[getMoves] No movesWithTake. Returning "+s.length+" movesWithoutTake"),{movesWithoutTake:s};if(e&&2<=a.length){console.log("[getMoves] "+a.length+" movesWithTake - will look for retake");var i=[];if(a.forEach(function(e){var t=e.takenPiece;console.log("[getMoves] Execute move "+e+" with "+t.position.toString()),r.applyMove(e),c.getMoves(r,!1).movesWithTake&&(console.log("[getMoves] Can retake after move "+e),i.push(e)),console.log("[getMoves] Reverse move "+e),r.revertMove(e)}),0<i.length)return console.log("[getMoves] Returning "+i.length+" movesWithRetake"),{movesWithTake:i}}return console.log("[getMoves] Returning "+a.length+" movesWithTake"),{movesWithTake:a}},c.toJSON=function(){return{x:c.position.x,y:c.position.y,player:c.player.id,king:!0}},u(c,t)}return t(r,i),r}(),d=function(e){function r(){var e,t,a;s(this,r);for(var i=arguments.length,o=Array(i),n=0;n<i;n++)o[n]=arguments[n];return(t=a=u(this,(e=r.__proto__||Object.getPrototypeOf(r)).call.apply(e,[this].concat(o)))).toString=function(){return"o"},a.getDirections=function(){return a.player.side===v?[new p(-1,1),new p(1,1)]:[new p(1,-1),new p(-1,-1)]},a.getPromottedPiece=function(e){var t=a.player.side;return(t===c&&0===a.position.y||t===v&&a.position.y===e.size-1)&&new f(a.position,a.player)},a.getMoves=function(n){console.log("[getMoves] For piece "+a.toString()+" on position "+a.position.toString());var e=a.getDirections(),r=[],s=[];return e.forEach(function(e){console.log("[getMoves] Studying direction "+e.toString());var t=a.position.add(e);if(n.exists(t)){var i=n.at(t);if(i){if(!a.sameSide(i)){console.log("[getMoves] Piece "+i.position.toString()+" on the opposite side in this direction");var o=t.add(e);n.exists(o)&&!n.at(o)&&s.push(new g(a.position,o,i))}}else console.log("[getMoves] No piece in this direction"),r.push(new g(a.position,t))}}),0===s.length?(console.log("[getMoves] No movesWithTake. Returning "+r.length+" movesWithoutTake"),{movesWithoutTake:r}):{movesWithTake:s}},a.toJSON=function(){return{x:a.position.x,y:a.position.y,player:a.player.id,man:!0}},u(a,t)}return t(r,i),r}(),r=function e(t){var u=this;s(this,e),this.exists=function(e){return 0<=e.x&&e.x<=u.size-1&&0<=e.y&&e.y<=u.size-1},this.at=function(e){if(!u.exists(e))throw new Error("Invalid position "+e.toString()+" with board size "+u.size);return u.grid[e.x+u.size*e.y]},this.setAt=function(e,t){if(!u.exists(e))throw new Error("Invalid position "+e.toString()+" with board size "+u.size);(u.grid[e.x+u.size*e.y]=t).position=e},this.removeAt=function(e){if(!u.exists(e))throw new Error("Invalid position "+e.toString()+" with board size "+u.size);delete u.grid[e.x+u.size*e.y]},this.toString=function(){return[].concat(l(Array(u.size))).reduce(function(e,t,n){return e+[].concat(l(Array(u.size))).reduce(function(e,t,i){var o=u.at(new p(i,n));return e+(o?o.toString():"_")+"|"},"|")+"\n"},"")},this.init=function(e,t){for(var i=u.size/2-1,o=0;o<i;o+=1)for(var n=1-o%2;n<u.size;n+=2){var r=new p(e.side===v?n:u.size-n-1,e.side===v?o:u.size-o-1),s=new d(r,e);e.pieces.push(s),u.setAt(r,s);var a=new p(t.side===v?n:u.size-n-1,t.side===v?o:u.size-o-1),c=new d(a,t);t.pieces.push(c),u.setAt(a,c)}},this.get2ClosestPiecesAlongDir=function(e,t){for(var i=[],o=e.add(t);u.exists(o)&&i.length<2;){var n=u.at(o);n&&i.push(n),o=o.add(t)}return i},this.getMovesAlongDir=function(e,t,i){for(var o=3<arguments.length&&void 0!==arguments[3]&&arguments[3],n=4<arguments.length&&void 0!==arguments[4]&&arguments[4],r=[],s=i.add(t);u.exists(s)&&(!o||!s.equals(o));)r.push(new g(e,s,n)),s=s.add(t);return r},this.getMoves=function(e){var i=[],o=[];return e.pieces.forEach(function(e){if(e.active){var t=e.getMoves(u);t.movesWithoutTake?0===o.length&&i.push.apply(i,l(t.movesWithoutTake)):t.movesWithTake&&o.push.apply(o,l(t.movesWithTake))}}),0===o.length?i:o},this.applyMove=function(e){console.log("[applyMove] Move "+e.toString());var t=u.at(e.startPosition);u.setAt(e.endPosition,t),u.removeAt(e.startPosition);var i=t.getPromottedPiece(u);i&&(u.setAt(e.endPosition,i),t.player.pieces.push(i),(e.pieceBeforePromotion=t).active=!1),e.takenPiece&&(u.removeAt(e.takenPiece.position),e.takenPiece.active=!1)},this.revertMove=function(e){console.log("[revertMove] Move "+e.toString());var t=u.at(e.endPosition);e.pieceBeforePromotion&&(t.active=!1,t=e.pieceBeforePromotion,u.setAt(e.endPosition,t),t.active=!0),u.setAt(e.startPosition,t),u.removeAt(e.endPosition),e.takenPiece&&(u.setAt(e.takenPiece.position,e.takenPiece),e.takenPiece.takenPiece=!1)},this.size=t,this.grid=new Array(t*t)},a=function e(t,i){var o=this;s(this,e),this.sameSide=function(e){return o.id===e.id},this.id=t,this.side=i,this.pieces=[]};e.Board=r,e.Game=function e(t,i,o){var n=this;s(this,e),this.initTurn=function(){n.movesCandidates=n.board.getMoves(n.currentPlayer)},this.applyMove=function(e){if(e<0||e>n.movesCandidates.length-1)throw new Error("[applyMove] Invalid moveIndex "+e);var t=n.movesCandidates[e];n.board.applyMove(t),n.movesHistory.push(t);var i=n.board.at(t.endPosition).getMoves(n.board).movesWithTake;i?n.movesCandidates=i:(n.currentPlayer=n.currentPlayer.sameSide(n.player1)?n.player2:n.player1,n.initTurn())},this.player1=new a(i,c),this.player2=new a(o,v),this.currentPlayer=this.player1,this.board=new r(t),this.board.init(this.player1,this.player2),this.movesHistory=[],this.movesCandidates=[],this.initTurn()},e.Move=g,e.Piece=i,e.Man=d,e.King=f,e.Player=a,e.Position=p,Object.defineProperty(e,"__esModule",{value:!0})});
